{# Interactive content modules: Fill in the Gap, Challenge Input, Quiz #}

{% macro fill_in_the_gap(section_id, header_title, card_title, sentences, color='green') %}
    <section id="{{ section_id }}" class="mb-12 pt-16 -mt-16">
        <h2 class="section-header text-xl font-bold">{{ header_title }}</h2>
        <div class="lesson-card bg-{{ color }}-50 border-{{ color }}-200 border-2">
            <div class="lesson-card-header card-header flex justify-between items-center p-5">
                <h3 class="text-{{ color }}-800 font-bold">{{ card_title }}</h3>
                <span class="text-2xl text-{{ color }}-500 arrow-icon">▾</span>
            </div>
            <div class="lesson-card-content card-content show">
                <div class="mt-4 interactive-tool space-y-4 p-4 bg-white rounded">
                    
                    {% for sentence in sentences %}
                        <p class="text-lg mb-4 sentence-container" data-index="{{ loop.index0 }}">
                            {{ sentence.prefix | safe }}
                            <input type="text" 
                                data-correct="{{ sentence.answer | lower }}" 
                                class="gap-input p-1 border-b-2 border-gray-400 focus:border-{{ color }}-600 outline-none w-24 text-center bg-gray-50" 
                                placeholder="___">
                            {{ sentence.suffix | safe }}
                            <span class="feedback text-sm ml-2 font-bold"></span>
                        </p>
                    {% endfor %}

                    <button onclick="checkGaps(this)" class="check-btn mt-4 px-6 py-2 bg-{{ color }}-600 text-white rounded hover:bg-{{ color }}-700 transition">Verifica Risposte</button>
                    <div id="exercise-summary-{{ section_id }}" class="mt-4 font-bold"></div>
                </div>
            </div>
        </div>
    </section>

    <script>
        // Funzione per la correzione del Fill in the Gap
        window.checkGaps = function(button) {
            const container = button.closest('.lesson-card').querySelector('.interactive-tool');
            const inputs = container.querySelectorAll('.gap-input');
            let correctCount = 0;

            inputs.forEach(input => {
                const correct = input.getAttribute('data-correct').trim();
                const user = input.value.trim().toLowerCase();
                const feedbackSpan = input.nextElementSibling;
                
                // Pulisce le classi precedenti
                input.classList.remove('border-red-600', 'border-green-600', 'bg-green-100', 'bg-red-100');
                feedbackSpan.textContent = '';
                feedbackSpan.classList.remove('text-red-600', 'text-green-600');
                
                if (user === correct) {
                    feedbackSpan.textContent = '✔️';
                    feedbackSpan.classList.add('text-green-600');
                    input.classList.add('border-green-600', 'bg-green-100');
                    correctCount++;
                } else {
                    feedbackSpan.textContent = `❌ (${correct})`; // Mostra la risposta corretta
                    feedbackSpan.classList.add('text-red-600');
                    input.classList.add('border-red-600', 'bg-red-100');
                }
            });
            
            const total = inputs.length;
            const summary = container.querySelector(`#exercise-summary-{{ section_id }}`);
            summary.innerHTML = `Hai ottenuto ${correctCount} risposte corrette su ${total}.`;
            if (correctCount === total) {
                summary.innerHTML += ' Grande! Esercizio completato!';
            }
        }
    </script>
{% endmacro %}
